<!doctype html>
<html lang="zh-CN">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æµ·æ°´é±¼è¿›é”€å­˜ç®¡ç†ç³»ç»Ÿï¼ˆWPSåŒæ­¥ååŒç‰ˆï¼‰</title>
  <style>
    /* WPSåœ¨çº¿ååŒé¢æ¿ï¼ˆæ–°å¢ï¼‰ */
    .wps-online-panel {
      position: sticky;
      top: 0;
      z-index: 999;
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 10px;
    }
    .wps-online-panel .title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #007dff;
    }
    .wps-online-panel .tip {
      font-size: 13px;
      color: #666;
      margin-bottom: 8px;
      line-height: 1.4;
    }
    .wps-online-btn-group {
      display: flex;
      gap: 8px;
    }
    .wps-online-btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      color: white;
      /* å¢åŠ æŒ‰é’®ç‚¹å‡»åé¦ˆ */
      transition: background-color 0.2s;
    }
    /* ä¿®å¤æŒ‰é’®ç¦ç”¨çŠ¶æ€æ ·å¼ */
    .wps-online-btn:disabled {
      background-color: #ccc !important;
      cursor: not-allowed;
      opacity: 0.7;
    }
    .create-wps-file-btn {
      background: #4CAF50;
    }
    .create-wps-file-btn:hover:not(:disabled) {
      background: #45a049;
    }
    .sync-to-wps-btn {
      background: #007dff;
    }
    .sync-to-wps-btn:hover:not(:disabled) {
      background: #0069d9;
    }
    .view-wps-data-btn {
      background: #ff7d00;
    }
    .view-wps-data-btn:hover:not(:disabled) {
      background: #e67000;
    }

    /* åŸæœ‰æ ·å¼ä¿ç•™ï¼ˆå®Œæ•´ä¿ç•™ï¼Œä¸æ”¹åŠ¨ï¼‰ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }
    html {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      padding: 10px;
      background-color: #f5f5f5;
      font-size: 16px;
    }
    .tab-container {
      width: 100%;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      overflow-x: auto;
      white-space: nowrap;
      -webkit-overflow-scrolling: touch;
    }
    .tab-btn {
      padding: 16px 20px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      color: #666;
      flex-shrink: 0;
    }
    .tab-btn.active {
      color: #2196F3;
      border-bottom: 3px solid #2196F3;
    }
    .tab-content {
      padding: 15px;
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .form-group {
      margin-bottom: 15px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }
    .form-group label {
      width: 80px;
      text-align: right;
      font-size: 15px;
    }
    .form-group input {
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      flex: 1;
      min-width: 200px;
      font-size: 16px;
      autocomplete: off;
    }
    .form-group input:focus {
      border-color: #2196F3;
      outline: none;
      box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
    }
    .form-group button {
      padding: 12px 24px;
      background-color: #2196F3;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    .form-group button:hover {
      background-color: #1976D2;
    }
    .table-wrap {
      width: 100%;
      overflow-x: auto;
      margin-top: 15px;
      -webkit-overflow-scrolling: touch;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px 10px;
      text-align: center;
      border: 1px solid #ddd;
      font-size: 14px;
    }
    th {
      background-color: #f8f9fa;
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    .action-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 2px 0;
      font-size: 14px;
      min-height: 44px;
      min-width: 80px;
    }
    .death-btn {
      background-color: #f44336;
      color: #fff;
    }
    .sell-btn {
      background-color: #4CAF50;
      color: #fff;
    }
    .edit-btn {
      background-color: #ff9800;
      color: #fff;
    }
    .delete-btn {
      background-color: #f44336;
      color: #fff;
    }
    .batch-btn {
      margin: 10px 0;
      padding: 12px 20px;
      background-color: #9C27B0;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: none;
      width: 100%;
      font-size: 16px;
    }
    .batch-btn.show {
      display: block;
    }
    .stats {
      margin-top: 20px;
      padding: 20px 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
    }
    .stats p {
      margin: 10px 0;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
    }
    .stats span {
      font-weight: bold;
      color: #2196F3;
      text-align: right;
      min-width: 80px;
      display: inline-block;
    }
    .profit-span {
      color: #4CAF50;
    }
    input[type="checkbox"] {
      width: 20px;
      height: 20px;
    }
    .import-export-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .import-export-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
    }
    .export-btn {
      background-color: #4CAF50;
    }
    .import-btn {
      background-color: #ff9800;
    }
    .clear-btn {
      background-color: #f44336;
    }
    #import-input, #excel-import-input, #wps-create-import-input {
      display: none;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 300px;
    }
    .modal-input {
      width: 100%;
      padding: 10px;
      margin: 15px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .modal-btn-group {
      display: flex;
      gap: 10px;
    }
    .modal-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
    }
    .confirm-btn {
      background-color: #f44336;
    }
    .cancel-btn {
      background-color: #999;
    }
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #666;
    }
    .loading.show {
      display: block;
    }
    tr.selected {
      background-color: #e3f2fd !important;
    }
    .filter-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .filter-input {
      flex: 1;
      min-width: 150px;
    }
  </style>
  <!-- å¼•å…¥Excelå¤„ç†åº“ï¼ˆå…è´¹å¼€æºï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
 </head>
 <body>
  <!-- WPSåœ¨çº¿ååŒé¢æ¿ï¼ˆä¿®æ”¹ï¼šåˆ›å»ºæœ¬åœ°Excelè¡¨æ ¼ï¼‰ -->
  <div class="wps-online-panel">
    <div class="title">ğŸ“Š WPSåŒæ­¥ååŒï¼ˆæœ¬åœ°Excelç‰ˆï¼‰</div>
    <div class="tip">1. åˆ›å»ºæœ¬åœ°Excelè¡¨æ ¼ â†’ 2. ç‚¹å‡»åŒæ­¥å¯¼å‡ºæœ€æ–°æ•°æ® â†’ 3. ç‚¹å‡»æŸ¥çœ‹å¯¼å…¥æ›´æ–°æ•°æ®</div>
    <div class="wps-online-btn-group">
      <!-- æ–°å¢ï¼šåˆ›å»ºè¡¨æ ¼æ—¶æ”¯æŒæ‰‹åŠ¨å¯¼å…¥çš„æ–‡ä»¶é€‰æ‹©æ¡† -->
      <input type="file" id="wps-create-import-input" accept=".xlsx, .xls" onchange="importToNewWpsFile(event)">
      <!-- ä¿®å¤æŒ‰é’®IDå’Œæ ·å¼ï¼Œç¡®ä¿å¯ç‚¹å‡» -->
      <button class="wps-online-btn create-wps-file-btn" id="createWpsBtn">ğŸ†• åˆ›å»ºæœ¬åœ°Excelè¡¨æ ¼</button>
      <button class="wps-online-btn sync-to-wps-btn" id="syncWpsBtn">ğŸ”„ åŒæ­¥å¯¼å‡ºæ•°æ®</button>
      <button class="wps-online-btn view-wps-data-btn" id="viewWpsBtn">ğŸ‘ï¸ å¯¼å…¥æ›´æ–°æ•°æ®</button>
    </div>
    <div id="wps-status" style="margin-top:8px; font-size:13px; color:#666; text-align:center;">æœªåˆ›å»ºæœ¬åœ°Excelè¡¨æ ¼</div>
  </div>

  <!-- åŸæœ‰é¡µé¢ç»“æ„ -->
  <div class="tab-container">
   <div class="tabs">
    <!-- ä¿®å¤ï¼šç§»é™¤onclickå±æ€§ï¼Œæ”¹ä¸ºJSåŠ¨æ€ç»‘å®šï¼Œé¿å…eventå¯¹è±¡é—®é¢˜ -->
    <button class="tab-btn active" data-tab="purchase">è¿›è´§å½•å…¥</button>
    <button class="tab-btn" data-tab="stock">åº“å­˜ç®¡ç†</button>
    <button class="tab-btn" data-tab="stats">æ•°æ®ç»Ÿè®¡</button>
    <button class="tab-btn" data-tab="sale">å‡ºè´§å½•å…¥</button>
   </div>
   <!-- è¿›è´§å½•å…¥ -->
   <div id="purchase" class="tab-content active">
    <div class="filter-group">
      <label>æ—¥æœŸç­›é€‰ï¼š</label>
      <input type="date" id="purchase-start-date" class="filter-input">
      <input type="date" id="purchase-end-date" class="filter-input">
      <button onclick="filterPurchaseByDate()">ç­›é€‰</button>
      <button onclick="resetPurchaseFilter()">é‡ç½®</button>
    </div>
    <div class="form-group">
     <label>é±¼åç§°ï¼š</label> <input type="text" id="purchase-name" placeholder="è¾“å…¥æµ·æ°´é±¼åç§°" inputmode="text">
    </div>
    <div class="form-group">
     <label>å•ä»·ï¼š</label> <input type="text" id="purchase-price" placeholder="æ”¯æŒç®—å¼ï¼Œå¦‚10+2" inputmode="numeric">
    </div>
    <div class="form-group">
     <label>æ•°é‡ï¼š</label> <input type="number" id="purchase-count" min="1" value="1" inputmode="numeric">
    </div>
    <div class="form-group">
     <label>è¿è´¹ï¼š</label> <input type="text" id="purchase-freight" placeholder="æ”¯æŒç®—å¼ï¼Œå¦‚20+5" inputmode="numeric">
    </div>
    <div class="form-group">
     <label>æ—¥æœŸï¼š</label> <input type="date" id="purchase-date">
    </div>
    <div class="form-group">
     <button onclick="addPurchase()">æ·»åŠ è¿›è´§è®°å½•</button>
    </div>
    <div class="loading" id="purchase-loading">åŠ è½½ä¸­...</div>
    <div class="table-wrap">
     <table id="purchase-table">
      <thead>
       <tr>
        <th>é±¼åç§°</th>
        <th>å•ä»·(å…ƒ)</th>
        <th>æ•°é‡</th>
        <th>è¿è´¹(å…ƒ)</th>
        <th>è¿›è´§æˆæœ¬(å…ƒ)</th>
        <th>æ—¥æœŸ</th>
        <th>æ“ä½œ</th>
       </tr>
      </thead>
      <tbody></tbody>
     </table>
    </div>
   </div>
   <!-- åº“å­˜ç®¡ç† -->
   <div id="stock" class="tab-content">
    <div class="filter-group">
      <label>æœç´¢ï¼š</label>
      <input type="text" id="stock-search" placeholder="è¾“å…¥é±¼åç§°æœç´¢" class="filter-input" oninput="searchStock()">
    </div>
    <button class="batch-btn" id="batch-death-btn" onclick="batchDeath()">æ‰¹é‡æ ‡è®°æ­»äº¡</button>
    <div class="loading" id="stock-loading">åŠ è½½ä¸­...</div>
    <div class="table-wrap">
     <table id="stock-table">
      <thead>
       <tr>
        <th>è¿›è´§æ—¥æœŸ</th>
        <th>é±¼åç§°</th>
        <th>å•ä»·(å…ƒ)</th>
        <th>åº“å­˜æ•°é‡</th>
        <th>æ“ä½œ</th>
       </tr>
      </thead>
      <tbody></tbody>
     </table>
    </div>
   </div>
   <!-- æ•°æ®ç»Ÿè®¡ -->
   <div id="stats" class="tab-content">
    <div class="import-export-group">
     <button class="import-export-btn export-btn" onclick="exportData()">å¯¼å‡ºJSONæ•°æ®</button>
     <!-- æ–°å¢ï¼šExcelå¯¼å‡ºæŒ‰é’® -->
     <button class="import-export-btn export-btn" onclick="exportToExcel()">å¯¼å‡ºExcelæ•°æ®</button>
     <label class="import-export-btn import-btn" for="import-input">å¯¼å…¥JSONæ•°æ®</label>
     <!-- æ–°å¢ï¼šExcelå¯¼å…¥çš„labelå’Œinput -->
     <label class="import-export-btn import-btn" for="excel-import-input">å¯¼å…¥Excelæ•°æ®</label>
     <button class="import-export-btn clear-btn" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
     <input type="file" id="import-input" accept=".json" onchange="importData(event)">
     <!-- ä¿®å¤ï¼šæ·»åŠ ç¼ºå¤±çš„excel-import-inputå…ƒç´  -->
     <input type="file" id="excel-import-input" accept=".xlsx, .xls" onchange="importFromExcel(event)">
    </div>
    <div class="stats">
     <p>ç´¯è®¡è¿›è´§æˆæœ¬ï¼š<span id="total-purchase">0.00</span> å…ƒ</p>
     <p>ç´¯è®¡å‡ºè´§æ”¶å…¥ï¼š<span id="total-sale">0.00</span> å…ƒ</p>
     <p>å½“å‰åº“å­˜æ€»ä»·å€¼ï¼š<span id="total-stock-value">0.00</span> å…ƒ</p>
     <p>æ€»æ”¶ç›Šï¼š<span id="total-profit" class="profit-span">0.00</span> å…ƒ</p>
     <p>ç»¼åˆå‡€æ”¶ç›Šï¼š<span id="net-profit" class="profit-span">0.00</span> å…ƒ</p>
    </div>
   </div>
   <!-- å‡ºè´§å½•å…¥ -->
   <div id="sale" class="tab-content">
    <div class="filter-group">
      <label>æ—¥æœŸç­›é€‰ï¼š</label>
      <input type="date" id="sale-start-date" class="filter-input">
      <input type="date" id="sale-end-date" class="filter-input">
      <button onclick="filterSaleByDate()">ç­›é€‰</button>
      <button onclick="resetSaleFilter()">é‡ç½®</button>
    </div>
    <div class="form-group">
     <label>é±¼åç§°ï¼š</label> <input type="text" id="sale-name" placeholder="è¾“å…¥æµ·æ°´é±¼åç§°" inputmode="text">
    </div>
    <div class="form-group">
     <label>å”®ä»·ï¼š</label> <input type="text" id="sale-price" placeholder="æ”¯æŒç®—å¼ï¼Œå¦‚20*1.5" inputmode="numeric">
    </div>
    <div class="form-group">
     <label>æ•°é‡ï¼š</label> <input type="number" id="sale-count" min="1" value="1" inputmode="numeric">
    </div>
    <div class="form-group">
     <label>æ—¥æœŸï¼š</label> <input type="date" id="sale-date">
    </div>
    <div class="form-group">
     <button onclick="addSale()">æ·»åŠ å‡ºè´§è®°å½•</button>
    </div>
    <div class="loading" id="sale-loading">åŠ è½½ä¸­...</div>
    <div class="table-wrap">
     <table id="sale-table">
      <thead>
       <tr>
        <th>é±¼åç§°</th>
        <th>å”®ä»·(å…ƒ)</th>
        <th>æ•°é‡</th>
        <th>å‡ºè´§æ”¶å…¥(å…ƒ)</th>
        <th>æ—¥æœŸ</th>
        <th>æ“ä½œ</th>
       </tr>
      </thead>
      <tbody></tbody>
     </table>
    </div>
   </div>
  </div>
  <!-- æ­»äº¡å¼¹çª— -->
  <div class="modal" id="deathModal">
   <div class="modal-content">
    <h3 style="text-align: center;">è¾“å…¥æ­»äº¡æ•°é‡</h3>
    <input type="number" class="modal-input" id="deathCount" min="1" placeholder="è¯·è¾“å…¥æ•°é‡" inputmode="numeric">
    <div class="modal-btn-group">
     <button class="modal-btn confirm-btn" onclick="confirmDeath()">ç¡®è®¤</button>
     <button class="modal-btn cancel-btn" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
   </div>
  </div>

  <script>
    // ========== æ•°æ®å­˜å‚¨ï¼ˆåŸæœ‰ï¼‰ ==========
    let purchaseData = JSON.parse(localStorage.getItem('purchaseData')) || [];
    let saleData = JSON.parse(localStorage.getItem('saleData')) || [];
    let stockData = JSON.parse(localStorage.getItem('stockData')) || [];
    let selectedStockIds = [];
    let currentStockId = '';
    let debounceTimer = null;
    let originalPurchaseData = [...purchaseData];
    let originalSaleData = [...saleData];
    let originalStockData = [...stockData];

    // ========== WPSåŒæ­¥ååŒæ ¸å¿ƒé…ç½®ï¼ˆä¿®æ”¹ï¼šæœ¬åœ°Excelç‰ˆï¼‰ ==========
    // ä¿®æ”¹2ï¼šä¼˜å…ˆä»localStorageè¯»å–çŠ¶æ€ï¼Œç¡®ä¿é¡µé¢åˆ·æ–°åçŠ¶æ€ä¸ä¸¢å¤±
    let wpsOnlineFileCreated = localStorage.getItem('wpsOnlineFileCreated') === 'true'; 
    const WPS_ONLINE_FILE_NAME = 'æµ·æ°´é±¼è¿›é”€å­˜_åŒæ­¥ååŒè¡¨æ ¼.xlsx'; // å›ºå®šæ–‡ä»¶åï¼Œä¾¿äºè¯†åˆ«

    // æ–°å¢ï¼šåŒæ­¥è¿›è´§æ•°æ®åˆ°åº“å­˜çš„è¾…åŠ©å‡½æ•°ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
    function syncPurchaseToStock() {
      try {
        // æ¸…ç©ºåŸæœ‰åº“å­˜ï¼Œé‡æ–°ä»è¿›è´§æ•°æ®ç”Ÿæˆï¼ˆé¿å…é‡å¤ï¼‰
        stockData = [];
        
        // éå†æ‰€æœ‰è¿›è´§è®°å½•ï¼Œç”Ÿæˆå¯¹åº”çš„åº“å­˜è®°å½•
        purchaseData.forEach(item => {
          if (!item.name || item.count <= 0) return; // è·³è¿‡æ— æ•ˆè®°å½•
          
          // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒåç§°+å•ä»·çš„åº“å­˜è®°å½•
          const stockIndex = stockData.findIndex(i => i.name === item.name && i.price === item.price);
          
          if (stockIndex > -1) {
            // å·²æœ‰è®°å½•ï¼Œç´¯åŠ æ•°é‡
            stockData[stockIndex].count += item.count;
          } else {
            // æ— è®°å½•ï¼Œæ–°å¢åº“å­˜é¡¹
            stockData.push({
              stockId: item.purchaseId || generateId(),
              name: item.name,
              price: item.price,
              count: item.count,
              date: item.date
            });
          }
        });
        
        // æ‰£é™¤å·²å‡ºè´§çš„æ•°é‡ï¼ˆä¿æŒåº“å­˜å‡†ç¡®æ€§ï¼‰
        saleData.forEach(saleItem => {
          let saleLeft = saleItem.count;
          // æŒ‰è¿›è´§æ—¥æœŸæ’åºï¼Œå…ˆè¿›å…ˆå‡º
          const sortedStock = [...stockData].sort((a, b) => new Date(a.date) - new Date(b.date));
          
          for (let i = 0; i < sortedStock.length && saleLeft > 0; i++) {
            if (sortedStock[i].name !== saleItem.name) continue;
            
            const reduce = Math.min(saleLeft, sortedStock[i].count);
            sortedStock[i].count -= reduce;
            saleLeft -= reduce;
            
            if (sortedStock[i].count <= 0) {
              sortedStock.splice(i, 1);
              i--; // ä¿®æ­£ç´¢å¼•
            }
          }
          
          // æ›´æ–°åº“å­˜æ•°æ®
          stockData = sortedStock;
        });
        
        originalStockData = [...stockData];
        saveData();
      } catch (e) {
        console.error('åŒæ­¥è¿›è´§åˆ°åº“å­˜å¤±è´¥ï¼š', e);
        alert('æ•°æ®åŒæ­¥å‡ºé”™ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      }
    }

    // ========== æ ¸å¿ƒä¿®å¤ï¼šå¼ºåŒ–æ–‡ä»¶è¦†ç›–é€»è¾‘çš„Excelå¯¼å‡ºå‡½æ•° ==========
    // æ ‡å‡†åŒ–çš„Excelå¯¼å‡ºå‡½æ•°ï¼ˆä¾›åˆ›å»º/åŒæ­¥/æ•°æ®ç»Ÿè®¡é¡µé¢è°ƒç”¨ï¼‰
    function standardExportToExcel(isSync = false) {
      try {
        const wb = XLSX.utils.book_new();
        // è¿›è´§æ•°æ®
        const purchaseSheetData = purchaseData.map(item => ({
          é±¼åç§°: item.name || "",
          å•ä»·: item.price ? item.price.toFixed(2) : "0.00",
          æ•°é‡: item.count || 0,
          è¿è´¹: item.freight ? item.freight.toFixed(2) : "0.00",
          è¿›è´§æˆæœ¬: item.cost ? item.cost.toFixed(2) : "0.00",
          è¿›è´§æ—¥æœŸ: item.date || "",
          è®°å½•ID: item.purchaseId || ""
        }));
        const purchaseWs = XLSX.utils.json_to_sheet(purchaseSheetData);
        XLSX.utils.book_append_sheet(wb, purchaseWs, "è¿›è´§è®°å½•");
        
        // å‡ºè´§æ•°æ®
        const saleSheetData = saleData.map(item => ({
          é±¼åç§°: item.name || "",
          å”®ä»·: item.price ? item.price.toFixed(2) : "0.00",
          æ•°é‡: item.count || 0,
          å‡ºè´§æ”¶å…¥: item.income ? item.income.toFixed(2) : "0.00",
          å‡ºè´§æ—¥æœŸ: item.date || "",
          è®°å½•ID: item.saleId || ""
        }));
        const saleWs = XLSX.utils.json_to_sheet(saleSheetData);
        XLSX.utils.book_append_sheet(wb, saleWs, "å‡ºè´§è®°å½•");
        
        // åº“å­˜æ•°æ®
        const stockSheetData = stockData.map(item => ({
          é±¼åç§°: item.name || "",
          å•ä»·: item.price ? item.price.toFixed(2) : "0.00",
          åº“å­˜æ•°é‡: item.count || 0,
          è¿›è´§æ—¥æœŸ: item.date || "",
          åº“å­˜ID: item.stockId || ""
        }));
        const stockWs = XLSX.utils.json_to_sheet(stockSheetData);
        XLSX.utils.book_append_sheet(wb, stockWs, "åº“å­˜æ•°æ®");
        
        // ========== å…³é”®ä¼˜åŒ–ï¼šå¼ºåˆ¶æ–‡ä»¶è¦†ç›–é€»è¾‘ ==========
        // 1. å…ˆæ¸…é™¤å¯èƒ½å­˜åœ¨çš„åŒåæ–‡ä»¶ä¸‹è½½ç¼“å­˜
        const oldLink = document.querySelector(`a[download="${WPS_ONLINE_FILE_NAME}"]`);
        if (oldLink) {
          URL.revokeObjectURL(oldLink.href);
          document.body.removeChild(oldLink);
        }
        
        // 2. å¼ºåˆ¶ä½¿ç”¨å›ºå®šæ–‡ä»¶åï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨è¦†ç›–åŒåæ–‡ä»¶
        // å¯¹äºChrome/Firefoxç­‰ä¸»æµæµè§ˆå™¨ï¼ŒåŒåæ–‡ä»¶ä¼šç›´æ¥è¦†ç›–ä¸‹è½½æ–‡ä»¶å¤¹ä¸­çš„åŸæœ‰æ–‡ä»¶
        XLSX.writeFile(wb, WPS_ONLINE_FILE_NAME, { 
          bookType: 'xlsx',
          type: 'file',
          // é¢å¤–é…ç½®ç¡®ä¿æ–‡ä»¶æ ¼å¼å…¼å®¹WPS
          cellStyles: true,
          sheetStubs: true
        });
        
        // è®°å½•æœ€ååŒæ­¥æ—¶é—´
        if (isSync) {
          localStorage.setItem('lastSyncTime', new Date().toLocaleString());
        }
        
        return true;
      } catch (e) {
        alert(`Excelå¯¼å‡ºå¤±è´¥ï¼š${e.message}`);
        console.error('Excelå¯¼å‡ºé”™è¯¯ï¼š', e);
        return false;
      }
    }

    // 1. åˆ›å»ºæœ¬åœ°WPSåŒæ­¥ååŒExcelè¡¨æ ¼ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šå¤ç”¨æ ‡å‡†åŒ–å¯¼å‡ºé€»è¾‘ï¼‰
    function createWpsOnlineFile() {
      try {
        // æç¤ºç”¨æˆ·æ–‡ä»¶å°†è¢«åˆ›å»º
        const confirmCreate = confirm(`å³å°†åˆ›å»ºæœ¬åœ°Excelè¡¨æ ¼ï¼š
æ–‡ä»¶åï¼š${WPS_ONLINE_FILE_NAME}
åç»­ã€ŒåŒæ­¥å¯¼å‡ºæ•°æ®ã€æ“ä½œä¼šç›´æ¥è¦†ç›–æ­¤æ–‡ä»¶ï¼
æ˜¯å¦ç»§ç»­åˆ›å»ºï¼Ÿ`);
        
        if (!confirmCreate) return;
        
        // ç›´æ¥è°ƒç”¨æ ‡å‡†åŒ–å¯¼å‡ºå‡½æ•°
        const exportSuccess = standardExportToExcel(false);
        if (!exportSuccess) return;
        
        // æ›´æ–°çŠ¶æ€å’Œæç¤º
        wpsOnlineFileCreated = true;
        document.getElementById('wps-status').innerText = `âœ… å·²åˆ›å»ºæœ¬åœ°Excelè¡¨æ ¼ï¼š${WPS_ONLINE_FILE_NAME}ï¼ˆå·²ä¿å­˜åˆ°ç”µè„‘ï¼‰`;
        localStorage.setItem('wpsOnlineFileCreated', 'true'); // æœ¬åœ°å­˜å‚¨æ ‡è®°
        
        // å‹å¥½æç¤º
        alert(`âœ… æœ¬åœ°Excelè¡¨æ ¼åˆ›å»ºæˆåŠŸï¼
æ–‡ä»¶å·²ä¿å­˜åˆ°æ‚¨çš„ç”µè„‘é»˜è®¤ä¸‹è½½æ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶åï¼š${WPS_ONLINE_FILE_NAME}
åç»­ç‚¹å‡»ã€ŒåŒæ­¥å¯¼å‡ºæ•°æ®ã€ä¼šç›´æ¥è¦†ç›–æ­¤æ–‡ä»¶ï¼Œæ›´æ–°ä¸ºæœ€æ–°æ•°æ®ã€‚`);
      } catch (e) {
        console.error('åˆ›å»ºExcelè¡¨æ ¼å¤±è´¥ï¼š', e);
        alert('åˆ›å»ºè¡¨æ ¼å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // æ–°å¢ï¼šåˆ›å»ºè¡¨æ ¼æ—¶æ‰‹åŠ¨å¯¼å…¥Excelæ–‡ä»¶ï¼ˆç›´æ¥åˆå§‹åŒ–æ•°æ®ï¼‰
    function importToNewWpsFile(event) {
      try {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: 'array' });
            
            // ä»å¯¼å…¥çš„Excelåˆå§‹åŒ–æ•°æ®
            purchaseData = [];
            saleData = [];
            
            // å¯¼å…¥è¿›è´§æ•°æ®
            if (wb.Sheets["è¿›è´§è®°å½•"]) {
              const purchaseDataFromExcel = XLSX.utils.sheet_to_json(wb.Sheets["è¿›è´§è®°å½•"]);
              purchaseData = purchaseDataFromExcel.map(item => ({
                purchaseId: item.è®°å½•ID || generateId(),
                name: item.é±¼åç§° || "",
                price: parseFloat(item.å•ä»·) || 0,
                count: parseInt(item.æ•°é‡) || 0,
                freight: parseFloat(item.è¿è´¹) || 0,
                cost: parseFloat(item.è¿›è´§æˆæœ¬) || 0,
                date: item.è¿›è´§æ—¥æœŸ || new Date().toISOString().split('T')[0]
              })).filter(item => item.name && item.count > 0);
            }
            
            // å¯¼å…¥å‡ºè´§æ•°æ®
            if (wb.Sheets["å‡ºè´§è®°å½•"]) {
              const saleDataFromExcel = XLSX.utils.sheet_to_json(wb.Sheets["å‡ºè´§è®°å½•"]);
              saleData = saleDataFromExcel.map(item => ({
                saleId: item.è®°å½•ID || generateId(),
                name: item.é±¼åç§° || "",
                price: parseFloat(item.å”®ä»·) || 0,
                count: parseInt(item.æ•°é‡) || 0,
                income: parseFloat(item.å‡ºè´§æ”¶å…¥) || 0,
                date: item.å‡ºè´§æ—¥æœŸ || new Date().toISOString().split('T')[0]
              })).filter(item => item.name && item.count > 0);
            }
            
            // æ ¸å¿ƒä¿®å¤ï¼šå¯¼å…¥ååŒæ­¥è¿›è´§æ•°æ®åˆ°åº“å­˜
            syncPurchaseToStock();
            
            // æ›´æ–°çŠ¶æ€å’Œå­˜å‚¨
            wpsOnlineFileCreated = true;
            originalPurchaseData = [...purchaseData];
            originalSaleData = [...saleData];
            originalStockData = [...stockData];
            localStorage.setItem('wpsOnlineFileCreated', 'true');
            saveData();
            
            // é‡æ–°æ¸²æŸ“
            renderAllTables();
            updateStats();
            document.getElementById('wps-status').innerText = `âœ… å·²ä»Excelå¯¼å…¥æ•°æ®å¹¶åˆ›å»ºæœ¬åœ°è¡¨æ ¼ï¼š${WPS_ONLINE_FILE_NAME}`;
            
            alert(`æˆåŠŸå¯¼å…¥Excelæ•°æ®å¹¶åˆ›å»ºæœ¬åœ°è¡¨æ ¼ï¼
- è¿›è´§è®°å½•ï¼š${purchaseData.length} æ¡
- å‡ºè´§è®°å½•ï¼š${saleData.length} æ¡
- åº“å­˜è®°å½•ï¼š${stockData.length} æ¡
åç»­ã€ŒåŒæ­¥å¯¼å‡ºæ•°æ®ã€ä¼šç›´æ¥è¦†ç›–æ­¤æ–‡ä»¶ã€‚`);
            
            event.target.value = '';
          } catch (e) {
            alert(`å¯¼å…¥å¤±è´¥ï¼š${e.message}ï¼Œè¯·ç¡®ä¿Excelæ ¼å¼æ­£ç¡®`);
            console.error('Excelå¯¼å…¥é”™è¯¯ï¼š', e);
          }
        };
        reader.readAsArrayBuffer(file);
      } catch (e) {
        console.error('å¯¼å…¥Excelæ–‡ä»¶å¤±è´¥ï¼š', e);
        alert('æ–‡ä»¶å¯¼å…¥å‡ºé”™ï¼Œè¯·é‡è¯•');
      }
    };

    // 2. åŒæ­¥å¯¼å‡ºæ•°æ®ï¼ˆå¼ºåŒ–æ–‡ä»¶è¦†ç›–é€»è¾‘ï¼‰
    function syncToWpsOnline() {
      try {
        if (!wpsOnlineFileCreated) {
          alert('è¯·å…ˆåˆ›å»ºæœ¬åœ°Excelè¡¨æ ¼');
          return;
        }
        
        // å…³é”®ï¼šæ˜ç¡®æç¤ºç”¨æˆ·æ–‡ä»¶å°†è¢«è¦†ç›–
        const confirmSync = confirm(`âš ï¸ åŒæ­¥å¯¼å‡ºæç¤ºï¼š
æ­¤æ“ä½œå°†ç›´æ¥è¦†ç›–æ‚¨ç”µè„‘ä¸‹è½½æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶ï¼š
${WPS_ONLINE_FILE_NAME}
åŸæœ‰æ–‡ä»¶å†…å®¹å°†è¢«æœ€æ–°æ•°æ®å®Œå…¨æ›¿æ¢ï¼
æ˜¯å¦ç»§ç»­åŒæ­¥ï¼Ÿ`);
        
        if (!confirmSync) return;
        
        // ç¦ç”¨åŒæ­¥æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        const syncBtn = document.getElementById('syncWpsBtn');
        syncBtn.disabled = true;
        syncBtn.textContent = 'ğŸ”„ åŒæ­¥ä¸­...';
        
        // è°ƒç”¨æ ‡å‡†åŒ–å¯¼å‡ºå‡½æ•°ï¼ˆæ ‡è®°ä¸ºåŒæ­¥æ“ä½œï¼‰
        const exportSuccess = standardExportToExcel(true);
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        syncBtn.disabled = false;
        syncBtn.textContent = 'ğŸ”„ åŒæ­¥å¯¼å‡ºæ•°æ®';
        
        if (!exportSuccess) return;
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        const lastSyncTime = localStorage.getItem('lastSyncTime');
        document.getElementById('wps-status').innerText = `âœ… å·²åŒæ­¥æœ€æ–°æ•°æ®ï¼ˆæœ€ååŒæ­¥ï¼š${lastSyncTime}ï¼‰
ğŸ“ æ–‡ä»¶ï¼š${WPS_ONLINE_FILE_NAME}ï¼ˆå·²è¦†ç›–æ›´æ–°ï¼‰`;
        
        const alertMsg = `âœ… æ•°æ®åŒæ­¥å¯¼å‡ºæˆåŠŸï¼
ğŸ“ å·²è¦†ç›–æ‚¨ç”µè„‘ä¸­çš„æ–‡ä»¶ï¼š${WPS_ONLINE_FILE_NAME}
ğŸ“Š åŒ…å«æœ€æ–°çš„è¿›è´§ã€å‡ºè´§ã€åº“å­˜æ•°æ®
â° åŒæ­¥æ—¶é—´ï¼š${lastSyncTime}
æ‚¨å¯ä»¥ç›´æ¥æ‰“å¼€æ­¤æ–‡ä»¶æŸ¥çœ‹æœ€æ–°æ•°æ®ï¼ˆæ— éœ€é‡æ–°ä¸‹è½½ï¼‰`;
        alert(alertMsg);
        
      } catch (e) {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const syncBtn = document.getElementById('syncWpsBtn');
        if (syncBtn) {
          syncBtn.disabled = false;
          syncBtn.textContent = 'ğŸ”„ åŒæ­¥å¯¼å‡ºæ•°æ®';
        }
        
        alert(`åŒæ­¥å¯¼å‡ºå¤±è´¥ï¼š${e.message}`);
        console.error('åŒæ­¥Excelé”™è¯¯ï¼š', e);
      }
    }

    // 3. å¯¼å…¥æ›´æ–°æ•°æ®ï¼ˆä»æœ¬åœ°Excelæ–‡ä»¶å¯¼å…¥æ•°æ®åˆ°ç³»ç»Ÿï¼‰
    function viewWpsOnlineData() {
      try {
        if (!wpsOnlineFileCreated) {
          alert('è¯·å…ˆåˆ›å»ºæœ¬åœ°Excelè¡¨æ ¼');
          return;
        }
        const alertMsg = `è¯·é€‰æ‹©æ‚¨ç”µè„‘ä¸­çš„Excelæ–‡ä»¶å¯¼å…¥æ›´æ–°æ•°æ®ï¼š
ğŸ“ æ¨èæ–‡ä»¶ï¼š${WPS_ONLINE_FILE_NAME}
âœ… å¯¼å…¥åç³»ç»Ÿæ•°æ®ä¼šæ›´æ–°ä¸ºExcelä¸­çš„æœ€æ–°æ•°æ®`;
        alert(alertMsg);
        // è§¦å‘æ–‡ä»¶é€‰æ‹©æ¡†ï¼ˆç›´æ¥å¯¼å…¥ï¼‰
        document.getElementById('excel-import-input').click();
      } catch (e) {
        alert(`å¯¼å…¥æ›´æ–°æ•°æ®å¤±è´¥ï¼š${e.message}`);
        console.error('å¯¼å…¥Excelæ•°æ®é”™è¯¯ï¼š', e);
      }
    }

    // ========== WPSåŒæ­¥ååŒï¼šExcelå¯¼å…¥å¯¼å‡ºï¼ˆç»Ÿä¸€ä¸ºæ ‡å‡†åŒ–å‡½æ•°ï¼‰ ==========
    // æ•°æ®ç»Ÿè®¡é¡µé¢çš„Excelå¯¼å‡ºæŒ‰é’®è°ƒç”¨æ­¤å‡½æ•°
    function exportToExcel() {
      try {
        const exportSuccess = standardExportToExcel(false);
        if (exportSuccess) {
          // åŒæ­¥æ›´æ–°åˆ›å»ºçŠ¶æ€ï¼ˆå¦‚æœæ˜¯é¦–æ¬¡å¯¼å‡ºï¼‰
          if (!wpsOnlineFileCreated) {
            wpsOnlineFileCreated = true;
            localStorage.setItem('wpsOnlineFileCreated', 'true');
            document.getElementById('wps-status').innerText = `âœ… å·²åˆ›å»ºæœ¬åœ°Excelè¡¨æ ¼ï¼š${WPS_ONLINE_FILE_NAME}`;
          }
          alert(`Excelå¯¼å‡ºæˆåŠŸï¼
ğŸ“ æ–‡ä»¶å·²ä¿å­˜åˆ°æ‚¨çš„ç”µè„‘ï¼š${WPS_ONLINE_FILE_NAME}
å¦‚æœå·²æœ‰åŒåæ–‡ä»¶ï¼Œå·²è¢«æ–°æ–‡ä»¶è¦†ç›–`);
        }
      } catch (e) {
        console.error('å¯¼å‡ºExcelå¤±è´¥ï¼š', e);
        alert('Excelå¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // ä»WPSç¼–è¾‘åçš„Excelå¯¼å…¥æ•°æ®ï¼ˆåŸæœ‰åŠŸèƒ½ï¼Œç”¨äºæŸ¥çœ‹ï¼‰
    function importFromExcel(event) {
      try {
        const file=event.target.files[0];
        if (!file) return;
        
        const reader=new FileReader();
        reader.onload=function(e) {
          try {
            const data=new Uint8Array(e.target.result);
            const wb=XLSX.read(data, { type: 'array' });
            
            // æ¸…ç©ºåŸæœ‰æ•°æ®
            purchaseData = [];
            saleData = [];
            
            // å¯¼å…¥è¿›è´§æ•°æ®
            if (wb.Sheets["è¿›è´§è®°å½•"]) {
              const purchaseDataFromExcel=XLSX.utils.sheet_to_json(wb.Sheets["è¿›è´§è®°å½•"]);
              purchaseData=purchaseDataFromExcel.map(item => ({
                purchaseId: item.è®°å½•ID || generateId(),
                name: item.é±¼åç§° || "",
                price: parseFloat(item.å•ä»·) || 0,
                count: parseInt(item.æ•°é‡) || 0,
                freight: parseFloat(item.è¿è´¹) || 0,
                cost: parseFloat(item.è¿›è´§æˆæœ¬) || 0,
                date: item.è¿›è´§æ—¥æœŸ || new Date().toISOString().split('T')[0]
              })).filter(item => item.name && item.count > 0);
            }
            
            // å¯¼å…¥å‡ºè´§æ•°æ®
            if (wb.Sheets["å‡ºè´§è®°å½•"]) {
              const saleDataFromExcel=XLSX.utils.sheet_to_json(wb.Sheets["å‡ºè´§è®°å½•"]);
              saleData=saleDataFromExcel.map(item => ({
                saleId: item.è®°å½•ID || generateId(),
                name: item.é±¼åç§° || "",
                price: parseFloat(item.å”®ä»·) || 0,
                count: parseInt(item.æ•°é‡) || 0,
                income: parseFloat(item.å‡ºè´§æ”¶å…¥) || 0,
                date: item.å‡ºè´§æ—¥æœŸ || new Date().toISOString().split('T')[0]
              })).filter(item => item.name && item.count > 0);
            }
            
            // æ ¸å¿ƒä¿®å¤ï¼šå¯¼å…¥ååŒæ­¥è¿›è´§æ•°æ®åˆ°åº“å­˜
            syncPurchaseToStock();
            
            // æ›´æ–°åŸå§‹æ•°æ®å’Œæœ¬åœ°å­˜å‚¨
            originalPurchaseData = [...purchaseData];
            originalSaleData = [...saleData];
            originalStockData = [...stockData];
            saveData();
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼å’Œç»Ÿè®¡
            renderAllTables();
            updateStats();
            
            alert(`Excelæ•°æ®å¯¼å…¥æˆåŠŸï¼
- è¿›è´§è®°å½•ï¼š${purchaseData.length} æ¡
- å‡ºè´§è®°å½•ï¼š${saleData.length} æ¡
- åº“å­˜è®°å½•ï¼š${stockData.length} æ¡`);
            event.target.value = '';
          } catch (e) {
            alert(`å¯¼å…¥å¤±è´¥ï¼š${e.message}ï¼Œè¯·ç¡®ä¿Excelæ ¼å¼æ­£ç¡®`);
            console.error('Excelå¯¼å…¥é”™è¯¯ï¼š', e);
          }
        };
        reader.readAsArrayBuffer(file);
      } catch (e) {
        console.error('å¯¼å…¥Excelæ•°æ®å¤±è´¥ï¼š', e);
        alert('æ•°æ®å¯¼å…¥å‡ºé”™ï¼Œè¯·é‡è¯•');
      }
    }

    // ========== åŸæœ‰åŠŸèƒ½ä¿ç•™ï¼ˆå®Œæ•´ä¿ç•™ï¼Œä¸æ”¹åŠ¨ï¼‰ ==========
    function saveData() {
      try {
        localStorage.setItem('purchaseData', JSON.stringify(purchaseData));
        localStorage.setItem('saleData', JSON.stringify(saleData));
        localStorage.setItem('stockData', JSON.stringify(stockData));
        
        // å¤§æ•°æ®é‡æé†’
        const total=purchaseData.length+saleData.length+stockData.length;
        if (total > 100 && !localStorage.getItem('backupTip')) {
          alert('æ•°æ®é‡è¾ƒå¤§ï¼Œå»ºè®®å¯¼å‡ºExcelå¤‡ä»½ï¼');
          localStorage.setItem('backupTip', '1');
        }
      } catch (e) {
        alert('æ•°æ®å­˜å‚¨å¤±è´¥ï¼Œè¯·æ¸…ç†å­˜å‚¨ç©ºé—´');
        console.error('æ•°æ®å­˜å‚¨é”™è¯¯ï¼š', e);
      }
    }

    // æ ¸å¿ƒä¿®å¤ï¼šé‡å†™switchTabå‡½æ•°ï¼Œè§£å†³eventå¯¹è±¡æœªå®šä¹‰é—®é¢˜
    function switchTab(tabId) {
      try {
        // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // æ¿€æ´»ç›®æ ‡æ ‡ç­¾é¡µ
        document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');
        document.getElementById(tabId).classList.add('active');
      } catch (e) {
        console.error('åˆ‡æ¢æ ‡ç­¾é¡µå¤±è´¥ï¼š', e);
      }
    }

    function calcExpr(expr) {
      try {
        const safeExpr=expr.replace(/[^0-9\+\-\*\/\(\)\.]/g, '');
        return safeExpr ? Function(`'use strict';return (${safeExpr})`)() : 0;
      } catch (e) {
        alert('ç®—å¼æ ¼å¼é”™è¯¯');
        console.error('ç®—å¼è®¡ç®—é”™è¯¯ï¼š', e);
        return 0;
      }
    }

    function generateId() {
      return Date.now()+Math.floor(Math.random()*1000);
    }

    function searchStock() {
      try {
        const keyword=document.getElementById('stock-search').value.trim().toLowerCase();
        document.getElementById('stock-loading').classList.add('show');
        clearTimeout(debounceTimer);
        debounceTimer=setTimeout(() => {
          const filtered=stockData.filter(item => item.name.toLowerCase().includes(keyword));
          renderFilteredStockTable(filtered);
          document.getElementById('stock-loading').classList.remove('show');
        }, 300);
      } catch (e) {
        console.error('æœç´¢åº“å­˜å¤±è´¥ï¼š', e);
        document.getElementById('stock-loading').classList.remove('show');
      }
    }

    function filterPurchaseByDate() {
      try {
        const start=document.getElementById('purchase-start-date').value;
        const end=document.getElementById('purchase-end-date').value;
        if (!start || !end) return alert('è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´');
        document.getElementById('purchase-loading').classList.add('show');
        setTimeout(() => {
          const filtered=purchaseData.filter(item => item.date >= start && item.date <= end);
          renderFilteredPurchaseTable(filtered);
          document.getElementById('purchase-loading').classList.remove('show');
        }, 300);
      } catch (e) {
        console.error('ç­›é€‰è¿›è´§æ•°æ®å¤±è´¥ï¼š', e);
        document.getElementById('purchase-loading').classList.remove('show');
      }
    }

    function resetPurchaseFilter() {
      try {
        document.getElementById('purchase-start-date').value = '';
        document.getElementById('purchase-end-date').value = '';
        renderPurchaseTable();
      } catch (e) {
        console.error('é‡ç½®è¿›è´§ç­›é€‰å¤±è´¥ï¼š', e);
      }
    }

    function filterSaleByDate() {
      try {
        const start=document.getElementById('sale-start-date').value;
        const end=document.getElementById('sale-end-date').value;
        if (!start || !end) return alert('è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´');
        document.getElementById('sale-loading').classList.add('show');
        setTimeout(() => {
          const filtered=saleData.filter(item => item.date >= start && item.date <= end);
          renderFilteredSaleTable(filtered);
          document.getElementById('sale-loading').classList.remove('show');
        }, 300);
      } catch (e) {
        console.error('ç­›é€‰å‡ºè´§æ•°æ®å¤±è´¥ï¼š', e);
        document.getElementById('sale-loading').classList.remove('show');
      }
    }

    function resetSaleFilter() {
      try {
        document.getElementById('sale-start-date').value = '';
        document.getElementById('sale-end-date').value = '';
        renderSaleTable();
      } catch (e) {
        console.error('é‡ç½®å‡ºè´§ç­›é€‰å¤±è´¥ï¼š', e);
      }
    }

    function renderFilteredPurchaseTable(filtered) {
      try {
        const tbody=document.querySelector('#purchase-table tbody');
        tbody.innerHTML = '';
        const frag=document.createDocumentFragment();
        if (filtered.length === 0) {
          const tr=document.createElement('tr');
          tr.innerHTML = '<td colspan="7" style="padding:20px;">æš‚æ— åŒ¹é…æ•°æ®</td>';
          frag.appendChild(tr);
        } else {
          filtered.forEach(item => {
            const tr=document.createElement('tr');
            tr.innerHTML = `
              <td>${item.name}</td>
              <td>${item.price.toFixed(2)}</td>
              <td>${item.count}</td>
              <td>${item.freight.toFixed(2)}</td>
              <td>${item.cost.toFixed(2)}</td>
              <td>${item.date}</td>
              <td>
                <button class="action-btn edit-btn" onclick="editPurchase(${item.purchaseId})">ç¼–è¾‘</button>
                <button class="action-btn delete-btn" onclick="deletePurchase(${item.purchaseId})">åˆ é™¤</button>
              </td>
            `;
            frag.appendChild(tr);
          });
        }
        tbody.appendChild(frag);
      } catch (e) {
        console.error('æ¸²æŸ“è¿›è´§è¡¨æ ¼å¤±è´¥ï¼š', e);
      }
    }

    function renderFilteredSaleTable(filtered) {
      try {
        const tbody=document.querySelector('#sale-table tbody');
        tbody.innerHTML = '';
        const frag=document.createDocumentFragment();
        if (filtered.length === 0) {
          const tr=document.createElement('tr');
          tr.innerHTML = '<td colspan="6" style="padding:20px;">æš‚æ— åŒ¹é…æ•°æ®</td>';
          frag.appendChild(tr);
        } else {
          filtered.forEach(item => {
            const tr=document.createElement('tr');
            tr.innerHTML = `
              <td>${item.name}</td>
              <td>${item.price.toFixed(2)}</td>
              <td>${item.count}</td>
              <td>${item.income.toFixed(2)}</td>
              <td>${item.date}</td>
              <td>
                <button class="action-btn edit-btn" onclick="editSale(${item.saleId})">ç¼–è¾‘</button>
                <button class="action-btn delete-btn" onclick="deleteSale(${item.saleId})">åˆ é™¤</button>
              </td>
            `;
            frag.appendChild(tr);
          });
        }
        tbody.appendChild(frag);
      } catch (e) {
        console.error('æ¸²æŸ“å‡ºè´§è¡¨æ ¼å¤±è´¥ï¼š', e);
      }
    }

    function renderFilteredStockTable(filtered) {
      try {
        const tbody=document.querySelector('#stock-table tbody');
        tbody.innerHTML = '';
        const frag=document.createDocumentFragment();
        if (filtered.length === 0) {
          const tr=document.createElement('tr');
          tr.innerHTML = '<td colspan="5" style="padding:20px;">æš‚æ— åŒ¹é…æ•°æ®</td>';
          frag.appendChild(tr);
        } else {
          filtered.forEach(item => {
            const tr=document.createElement('tr');
            tr.innerHTML = `
              <td>${item.date}</td>
              <td><input type="checkbox" onchange="selectStock(${item.stockId}, this)"> ${item.name}</td>
              <td>${item.price.toFixed(2)}</td>
              <td>${item.count}</td>
              <td>
                <button class="action-btn death-btn" onclick="markDeath(${item.stockId})">æ­»äº¡</button>
                <button class="action-btn sell-btn" onclick="sellStock(${item.stockId})">å–å‡º</button>
              </td>
            `;
            frag.appendChild(tr);
          });
        }
        tbody.appendChild(frag);
      } catch (e) {
        console.error('æ¸²æŸ“åº“å­˜è¡¨æ ¼å¤±è´¥ï¼š', e);
      }
    }

    function renderPurchaseTable() {
      renderFilteredPurchaseTable(purchaseData);
    }

    function renderSaleTable() {
      renderFilteredSaleTable(saleData);
    }

    function renderStockTable() {
      renderFilteredStockTable(stockData);
    }

    function renderAllTables() {
      try {
        renderPurchaseTable();
        renderSaleTable();
        renderStockTable();
      } catch (e) {
        console.error('æ¸²æŸ“æ‰€æœ‰è¡¨æ ¼å¤±è´¥ï¼š', e);
      }
    }

    function exportData() {
      try {
        const data={ purchaseData, saleData, stockData };
        const blob=new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a=document.createElement('a');
        a.href=URL.createObjectURL(blob);
        a.download = `æµ·æ°´é±¼è¿›é”€å­˜_${new Date().getTime()}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
        alert('JSONæ•°æ®å¯¼å‡ºæˆåŠŸ');
      } catch (e) {
        console.error('å¯¼å‡ºJSONå¤±è´¥ï¼š', e);
        alert('æ•°æ®å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    function importData(event) {
      try {
        const file=event.target.files[0];
        if (!file) return;
        const reader=new FileReader();
        reader.onload=(e) => {
          try {
            const data=JSON.parse(e.target.result);
            purchaseData=data.purchaseData || [];
            saleData=data.saleData || [];
            
            // æ ¸å¿ƒä¿®å¤ï¼šå¯¼å…¥JSONåä¹ŸåŒæ­¥è¿›è´§åˆ°åº“å­˜
            syncPurchaseToStock();
            
            originalPurchaseData = [...purchaseData];
            originalSaleData = [...saleData];
            originalStockData = [...stockData];
            saveData();
            renderAllTables();
            updateStats();
            alert('JSONæ•°æ®å¯¼å…¥æˆåŠŸ');
          } catch (e) {
            alert('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
            console.error('JSONå¯¼å…¥é”™è¯¯ï¼š', e);
          }
        };
        reader.readAsText(file);
        event.target.value = '';
      } catch (e) {
        console.error('å¯¼å…¥JSONæ•°æ®å¤±è´¥ï¼š', e);
        alert('æ•°æ®å¯¼å…¥å‡ºé”™ï¼Œè¯·é‡è¯•');
      }
    }

    function clearAllData() {
      try {
        if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
        purchaseData = [];
        saleData = [];
        stockData = [];
        originalPurchaseData = [];
        originalSaleData = [];
        originalStockData = [];
        selectedStockIds = [];
        localStorage.removeItem('backupTip');
        saveData();
        renderAllTables();
        updateStats();
        document.getElementById('batch-death-btn').classList.remove('show');
        alert('æ•°æ®å·²æ¸…ç©º');
      } catch (e) {
        console.error('æ¸…ç©ºæ•°æ®å¤±è´¥ï¼š', e);
        alert('æ¸…ç©ºæ•°æ®å‡ºé”™ï¼Œè¯·é‡è¯•');
      }
    }

    function openModal(stockId) {
      try {
        currentStockId=stockId;
        const item=stockData.find(i => i.stockId === stockId);
        if (item) document.getElementById('deathCount').max=item.count;
        document.getElementById('deathModal').style.display = 'flex';
      } catch (e) {
        console.error('æ‰“å¼€æ­»äº¡å¼¹çª—å¤±è´¥ï¼š', e);
      }
    }

    function closeModal() {
      try {
        document.getElementById('deathModal').style.display = 'none';
        currentStockId = '';
      } catch (e) {
        console.error('å…³é—­å¼¹çª—å¤±è´¥ï¼š', e);
      }
    }

    function confirmDeath() {
      try {
        const count=parseInt(document.getElementById('deathCount').value);
        if (isNaN(count) || count < 1) return alert('è¯·è¾“å…¥æœ‰æ•ˆæ•°é‡');
        const index=stockData.findIndex(i => i.stockId === currentStockId);
        if (index === -1) return closeModal();
        
        if (count >= stockData[index].count) {
          stockData.splice(index, 1);
        } else {
          stockData[index].count -= count;
        }
        originalStockData = [...stockData];
        saveData();
        renderStockTable();
        updateStats();
        closeModal();
        alert(`æˆåŠŸæ ‡è®° ${count} æ¡æ­»äº¡è®°å½•`);
      } catch (e) {
        console.error('ç¡®è®¤æ­»äº¡æ•°é‡å¤±è´¥ï¼š', e);
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    function addPurchase() {
      try {
        const name=document.getElementById('purchase-name').value.trim();
        const priceExpr=document.getElementById('purchase-price').value.trim();
        const count=parseInt(document.getElementById('purchase-count').value);
        const freightExpr=document.getElementById('purchase-freight').value.trim() || '0';
        const date=document.getElementById('purchase-date').value || new Date().toISOString().split('T')[0];
        
        if (!name || !priceExpr || isNaN(count)) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        
        const price=calcExpr(priceExpr);
        const freight=calcExpr(freightExpr);
        const cost=(price*count)+freight;
        const purchaseId=generateId();
        
        purchaseData.push({ purchaseId, name, price, count, freight, cost, date });
        originalPurchaseData = [...purchaseData];
        
        // æ‰‹åŠ¨æ·»åŠ è¿›è´§æ—¶ä¹Ÿè°ƒç”¨åŒæ­¥å‡½æ•°ï¼Œç¡®ä¿é€»è¾‘ç»Ÿä¸€
        syncPurchaseToStock();
        
        saveData();
        renderPurchaseTable();
        renderStockTable();
        updateStats();
        
        document.getElementById('purchase-name').value = '';
        document.getElementById('purchase-price').value = '';
        document.getElementById('purchase-count').value = 1;
        document.getElementById('purchase-freight').value = '';
      } catch (e) {
        console.error('æ·»åŠ è¿›è´§è®°å½•å¤±è´¥ï¼š', e);
        alert('æ·»åŠ è®°å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    function editPurchase(id) {
      try {
        const item=purchaseData.find(p => p.purchaseId === id);
        if (!item) return;
        document.getElementById('purchase-name').value=item.name;
        document.getElementById('purchase-price').value=item.price;
        document.getElementById('purchase-count').value=item.count;
        document.getElementById('purchase-freight').value=item.freight;
        document.getElementById('purchase-date').value=item.date;
        deletePurchase(id, true);
      } catch (e) {
        console.error('ç¼–è¾‘è¿›è´§è®°å½•å¤±è´¥ï¼š', e);
        alert('ç¼–è¾‘è®°å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    function deletePurchase(id, isEdit=false) {
      try {
        if (!isEdit && !confirm('åˆ é™¤è¿›è´§è®°å½•ä¼šæ‰£å‡åº“å­˜ï¼Œç¡®å®šå—ï¼Ÿ')) return;
        const index=purchaseData.findIndex(p => p.purchaseId === id);
        if (index === -1) return;
        const deleted=purchaseData.splice(index, 1)[0];
        originalPurchaseData = [...purchaseData];
        
        // åˆ é™¤è¿›è´§ååŒæ­¥åº“å­˜
        syncPurchaseToStock();
        
        saveData();
        renderPurchaseTable();
        renderStockTable();
        updateStats();
        if (!isEdit) alert('è¿›è´§è®°å½•å·²åˆ é™¤');
      } catch (e) {
        console.error('åˆ é™¤è¿›è´§è®°å½•å¤±è´¥ï¼š', e);
        alert('åˆ é™¤è®°å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    function addSale() {
      try {
        const name=document.getElementById('sale-name').value.trim();
        const priceExpr=document.getElementById('sale-price').value.trim();
        const count=parseInt(document.getElementById('sale-count').value);
        const date=document.getElementById('sale-date').value || new Date().toISOString().split('T')[0];
        
        if (!name || !priceExpr || isNaN(count)) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        
        const price=calcExpr(priceExpr);
        const income=price*count;
        const saleId=generateId();
        
        let stockLeft=count;
        const newStock = [...stockData].sort((a, b) => new Date(a.date)-new Date(b.date));
        
        for (let i=0; i < newStock.length && stockLeft > 0; i++) {
          if (newStock[i].name !== name) continue;
          const reduce=Math.min(stockLeft, newStock[i].count);
          newStock[i].count -= reduce;
          stockLeft -= reduce;
          if (newStock[i].count <= 0) newStock.splice(i, 1);
        }
        
        if (stockLeft > 0) return alert('åº“å­˜ä¸è¶³');
        
        saleData.push({ saleId, name, price, count, income, date });
        originalSaleData = [...saleData];
        stockData=newStock;
        originalStockData = [...stockData];
        
        saveData();
        renderSaleTable();
        renderStockTable();
        updateStats();
        
        document.getElementById('sale-name').value = '';
        document.getElementById('sale-price').value = '';
        document.getElementById('sale-count').value = 1;
      } catch (e) {
        console.error('æ·»åŠ å‡ºè´§è®°å½•å¤±è´¥ï¼š', e);
        alert('æ·»åŠ è®°å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    function editSale(id) {
      try {
        const item=saleData.find(s => s.saleId === id);
        if (!item) return;
        document.getElementById('sale-name').value=item.name;
        document.getElementById('sale-price').value=item.price;
        document.getElementById('sale-count').value=item.count;
        document.getElementById('sale-date').value=item.date;
        deleteSale(id, true);
      } catch (e) {
        console.error('ç¼–è¾‘å‡ºè´§è®°å½•å¤±è´¥ï¼š', e);
        alert('ç¼–è¾‘è®°å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    function deleteSale(id, isEdit=false) {
      try {
        if (!isEdit && !confirm('åˆ é™¤å‡ºè´§è®°å½•ä¼šæ¢å¤åº“å­˜ï¼Œç¡®å®šå—ï¼Ÿ')) return;
        const index=saleData.findIndex(s => s.saleId === id);
        if (index === -1) return;
        const deleted=saleData.splice(index, 1)[0];
        originalSaleData = [...saleData];
        
        // åˆ é™¤å‡ºè´§åé‡æ–°åŒæ­¥åº“å­˜
        syncPurchaseToStock();
        
        saveData();
        renderSaleTable();
        renderStockTable();
        updateStats();
        if (!isEdit) alert('å‡ºè´§è®°å½•å·²åˆ é™¤');
      } catch (e) {
        console.error('åˆ é™¤å‡ºè´§è®°å½•å¤±è´¥ï¼š', e);
        alert('åˆ é™¤è®°å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    function selectStock(id, el) {
      try {
        const index=selectedStockIds.indexOf(id);
        if (index > -1) {
          selectedStockIds.splice(index, 1);
          el.closest('tr').style.backgroundColor = '';
        } else {
          selectedStockIds.push(id);
          el.closest('tr').style.backgroundColor = '#e3f2fd';
        }
        document.getElementById('batch-death-btn').classList.toggle('show', selectedStockIds.length > 0);
      } catch (e) {
        console.error('é€‰æ‹©åº“å­˜å¤±è´¥ï¼š', e);
      }
    }

    function markDeath(id) {
      try {
        openModal(id);
      } catch (e) {
        console.error('æ ‡è®°æ­»äº¡å¤±è´¥ï¼š', e);
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    function batchDeath() {
      try {
        if (selectedStockIds.length === 0) return;
        const count=prompt('è¯·è¾“å…¥æ¯æ¡è®°å½•è¦æ ‡è®°çš„æ­»äº¡æ•°é‡ï¼š', 1);
        if (!count || isNaN(count) || count < 1) return;
        const num=parseInt(count);
        let success=0;
        
        for (let i=stockData.length-1; i >= 0; i--) {
          if (selectedStockIds.includes(stockData[i].stockId)) {
            if (stockData[i].count <= num) {
              stockData.splice(i, 1);
            } else {
              stockData[i].count -= num;
            }
            success++;
          }
        }
        
        selectedStockIds = [];
        originalStockData = [...stockData];
        saveData();
        renderStockTable();
        updateStats();
        document.getElementById('batch-death-btn').classList.remove('show');
        alert(`æˆåŠŸå¤„ç† ${success} æ¡åº“å­˜è®°å½•`);
      } catch (e) {
        console.error('æ‰¹é‡æ ‡è®°æ­»äº¡å¤±è´¥ï¼š', e);
        alert('æ‰¹é‡æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    function sellStock(id) {
      try {
        const item=stockData.find(i => i.stockId === id);
        if (item) {
          document.getElementById('sale-name').value=item.name;
          document.getElementById('sale-count').value=1;
          switchTab('sale');
        }
      } catch (e) {
        console.error('å–å‡ºåº“å­˜å¤±è´¥ï¼š', e);
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    function updateStats() {
      try {
        clearTimeout(debounceTimer);
        debounceTimer=setTimeout(() => {
          const totalPurchase=purchaseData.reduce((sum, item) => sum+item.cost, 0);
          const totalSale=saleData.reduce((sum, item) => sum+item.income, 0);
          const totalStock=stockData.reduce((sum, item) => sum+(item.price*item.count), 0);
          const profit=totalSale-totalPurchase;
          const netProfit=profit+totalStock;
          
          document.getElementById('total-purchase').textContent=totalPurchase.toFixed(2);
          document.getElementById('total-sale').textContent=totalSale.toFixed(2);
          document.getElementById('total-stock-value').textContent=totalStock.toFixed(2);
          document.getElementById('total-profit').textContent=profit.toFixed(2);
          document.getElementById('net-profit').textContent=netProfit.toFixed(2);
        }, 100);
      } catch (e) {
        console.error('æ›´æ–°ç»Ÿè®¡æ•°æ®å¤±è´¥ï¼š', e);
      }
    }

    // ========== é¡µé¢åˆå§‹åŒ–ï¼ˆæ–°å¢ï¼šè¯»å–WPSåˆ›å»ºæ ‡è®°ï¼‰ ==========
    window.onload=function() {
      try {
        // åˆå§‹åŒ–æ—¥æœŸ
        document.getElementById('purchase-date').value=new Date().toISOString().split('T')[0];
        document.getElementById('sale-date').value=new Date().toISOString().split('T')[0];
        
        // åˆå§‹åŒ–æ•°æ®
        purchaseData=Array.isArray(purchaseData) ? purchaseData : [];
        saleData=Array.isArray(saleData) ? saleData : [];
        stockData=Array.isArray(stockData) ? stockData : [];
        originalPurchaseData = [...purchaseData];
        originalSaleData = [...saleData];
        originalStockData = [...stockData];
        
        // åˆå§‹åŒ–æ—¶åŒæ­¥ä¸€æ¬¡è¿›è´§åˆ°åº“å­˜ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´
        syncPurchaseToStock();
        
        // æ›´æ–°WPSçŠ¶æ€æ˜¾ç¤º
        if (wpsOnlineFileCreated) {
          const lastSyncTime = localStorage.getItem('lastSyncTime');
          let statusText = `âœ… å·²åˆ›å»ºæœ¬åœ°Excelè¡¨æ ¼ï¼š${WPS_ONLINE_FILE_NAME}`;
          if (lastSyncTime) {
            statusText += `ï¼ˆæœ€ååŒæ­¥ï¼š${lastSyncTime}ï¼‰`;
          }
          document.getElementById('wps-status').innerText = statusText;
        }
        
        // æ ¸å¿ƒä¿®å¤ï¼šç»‘å®šæ ‡ç­¾é¡µç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            switchTab(this.dataset.tab);
          });
        });
        
        // ç»‘å®šWPSæŒ‰é’®äº‹ä»¶
        const createBtn = document.getElementById('createWpsBtn');
        const syncBtn = document.getElementById('syncWpsBtn');
        const viewBtn = document.getElementById('viewWpsBtn');
        
        // ç¡®ä¿æŒ‰é’®å­˜åœ¨å†ç»‘å®š
        if (createBtn) createBtn.addEventListener('click', createWpsOnlineFile);
        if (syncBtn) syncBtn.addEventListener('click', syncToWpsOnline);
        if (viewBtn) viewBtn.addEventListener('click', viewWpsOnlineData);
        
        // æ¸²æŸ“è¡¨æ ¼
        renderAllTables();
        updateStats();
      } catch (e) {
        console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼š', e);
        alert('ç³»ç»Ÿåˆå§‹åŒ–å‡ºé”™ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      }
    };
  </script>
 </body>
</html>